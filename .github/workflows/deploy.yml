name: Deploy Application

on:
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy"
        required: true
        default: "main"
        type: "string"
      environment:
        description: "Environment to deploy to"
        required: true
        default: "production"
        type: "choice"
        options:
          - production
          - staging
      deploy_frontend:
        description: "Deploy Frontend (React App)"
        required: true
        default: false
        type: "boolean"
      deploy_backend:
        description: "Deploy Backend (Node.js API)"
        required: true
        default: false
        type: "boolean"
      # Frontend specific inputs
      frontend_s3_bucket:
        description: "Frontend S3 Bucket Name (leave empty to use FRONTEND_S3_BUCKET env var)"
        required: false
        default: ""
        type: "string"
      cloudfront_distribution_id:
        description: "CloudFront Distribution ID (leave empty to use CLOUDFRONT_DISTRIBUTION_ID env var)"
        required: false
        default: ""
        type: "string"
      # Backend specific inputs
      backend_app_name:
        description: "Backend Elastic Beanstalk Application Name (leave empty to use BACKEND_APP_NAME env var)"
        required: false
        default: ""
        type: "string"
      backend_s3_bucket:
        description: "Backend S3 Bucket for deployment artifacts (leave empty to use BACKEND_S3_BUCKET env var)"
        required: false
        default: ""
        type: "string"
      # Common inputs
      aws_region:
        description: "AWS Region"
        required: true
        default: "us-east-1"
        type: "string"

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    outputs:
      deploy-frontend: ${{ steps.validate.outputs.deploy-frontend }}
      deploy-backend: ${{ steps.validate.outputs.deploy-backend }}
    steps:
      - name: Validate deployment selection
        id: validate
        run: |
          if [ "${{ github.event.inputs.deploy_frontend }}" = "false" ] && [ "${{ github.event.inputs.deploy_backend }}" = "false" ]; then
            echo "Error: You must select at least one component to deploy (Frontend or Backend)"
            exit 1
          fi
          echo "deploy-frontend=${{ github.event.inputs.deploy_frontend }}" >> $GITHUB_OUTPUT
          echo "deploy-backend=${{ github.event.inputs.deploy_backend }}" >> $GITHUB_OUTPUT
          echo "Deployment validation passed"

  deploy-frontend:
    needs: validate-inputs
    if: ${{ needs.validate-inputs.outputs.deploy-frontend == 'true' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: frontend/yarn.lock

      - name: Install dependencies
        working-directory: ./frontend
        run: yarn install --frozen-lockfile

      - name: Debug environment access
        run: |
          echo "Checking environment secrets and variables..."
          if [ -n "${{ secrets.AWS_ACCESS_KEY }}" ]; then
            echo "AWS_ACCESS_KEY secret is available"
          else
            echo "AWS_ACCESS_KEY secret is missing"
          fi
          if [ -n "${{ secrets.AWS_SECRET_KEY }}" ]; then
            echo "AWS_SECRET_KEY secret is available"
          else
            echo "AWS_SECRET_KEY secret is missing"
          fi
          if [ -n "${{ vars.FRONTEND_S3_BUCKET }}" ]; then
            echo "FRONTEND_S3_BUCKET variable is available"
          else
            echo "FRONTEND_S3_BUCKET variable is missing"
          fi
          if [ -n "${{ secrets.VITE_SUPABASE_URL }}" ]; then
            echo "VITE_SUPABASE_URL secret is available"
          else
            echo "VITE_SUPABASE_URL secret is missing"
          fi
          if [ -n "${{ secrets.VITE_SUPABASE_ANON_KEY }}" ]; then
            echo "VITE_SUPABASE_ANON_KEY secret is available"
          else
            echo "VITE_SUPABASE_ANON_KEY secret is missing"
          fi
          if [ -n "${{ vars.VITE_API_BASE_URL }}" ]; then
            echo "VITE_API_BASE_URL secret is available"
          else
            echo "VITE_API_BASE_URL secret is missing"
          fi

      - name: Build frontend
        working-directory: ./frontend
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
          VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL }}
        run: yarn build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ github.event.inputs.aws_region }}

      - name: Deploy to S3
        working-directory: ./frontend
        run: |
          S3_BUCKET="${{ github.event.inputs.frontend_s3_bucket || vars.FRONTEND_S3_BUCKET }}"
          if [ -z "$S3_BUCKET" ]; then
            echo "Error: S3 bucket not specified. Please provide frontend_s3_bucket input or set FRONTEND_S3_BUCKET environment variable."
            exit 1
          fi
          echo "Deploying to S3 bucket: $S3_BUCKET"
          aws s3 sync dist/ s3://$S3_BUCKET --delete --region ${{ github.event.inputs.aws_region }}

      - name: Invalidate CloudFront
        run: |
          CLOUDFRONT_ID="${{ github.event.inputs.cloudfront_distribution_id || vars.CLOUDFRONT_DISTRIBUTION_ID }}"
          if [ -n "$CLOUDFRONT_ID" ]; then
            echo "Invalidating CloudFront cache..."
            aws cloudfront create-invalidation --distribution-id $CLOUDFRONT_ID --paths "/*"
          else
            echo "No CloudFront distribution ID provided, skipping cache invalidation"
          fi

  deploy-backend:
    needs: validate-inputs
    if: ${{ needs.validate-inputs.outputs.deploy-backend == 'true' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.branch }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "yarn"
          cache-dependency-path: backend/yarn.lock

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        working-directory: ./backend
        run: yarn install --frozen-lockfile

      - name: Build backend
        working-directory: ./backend
        run: yarn build

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ github.event.inputs.aws_region }}

      - name: Create deployment package
        working-directory: ./backend
        run: |
          APP_NAME="${{ github.event.inputs.backend_app_name || vars.BACKEND_APP_NAME }}"
          if [ -z "$APP_NAME" ]; then
            echo "Error: App name not specified. Please provide backend_app_name input or set BACKEND_APP_NAME environment variable."
            exit 1
          fi
          python3 scripts/zip.py "$APP_NAME"

      - name: Generate version label
        id: version
        run: |
          APP_NAME="${{ github.event.inputs.backend_app_name || vars.BACKEND_APP_NAME }}"
          TIMESTAMP=$(date +%s)
          VERSION_LABEL="${APP_NAME}-${{ github.event.inputs.environment }}-${TIMESTAMP}"
          echo "version_label=${VERSION_LABEL}" >> $GITHUB_OUTPUT
          echo "s3_key=${VERSION_LABEL}.zip" >> $GITHUB_OUTPUT
          echo "app_name=${APP_NAME}" >> $GITHUB_OUTPUT

      - name: Upload to S3
        working-directory: ./backend
        run: |
          S3_BUCKET="${{ github.event.inputs.backend_s3_bucket || vars.BACKEND_S3_BUCKET }}"
          if [ -z "$S3_BUCKET" ]; then
            echo "Error: S3 bucket not specified. Please provide backend_s3_bucket input or set BACKEND_S3_BUCKET environment variable."
            exit 1
          fi
          aws s3 cp "${{ steps.version.outputs.app_name }}.zip" "s3://$S3_BUCKET/${{ steps.version.outputs.s3_key }}" --region "${{ github.event.inputs.aws_region }}"

      - name: Create Elastic Beanstalk application version
        run: |
          APP_NAME="${{ github.event.inputs.backend_app_name || vars.BACKEND_APP_NAME }}"
          S3_BUCKET="${{ github.event.inputs.backend_s3_bucket || vars.BACKEND_S3_BUCKET }}"
          aws elasticbeanstalk create-application-version \
            --application-name "$APP_NAME" \
            --version-label "${{ steps.version.outputs.version_label }}" \
            --region "${{ github.event.inputs.aws_region }}" \
            --source-bundle "S3Bucket=$S3_BUCKET,S3Key=${{ steps.version.outputs.s3_key }}" \
            --description "Deployed from branch ${{ github.event.inputs.branch }} on $(date)" \
            --auto-create-application

      - name: Deploy to Elastic Beanstalk
        run: |
          APP_NAME="${{ github.event.inputs.backend_app_name || vars.BACKEND_APP_NAME }}"
          ENVIRONMENT_NAME="${APP_NAME}"
          aws elasticbeanstalk update-environment \
            --environment-name "$ENVIRONMENT_NAME" \
            --version-label "${{ steps.version.outputs.version_label }}" \
            --region "${{ github.event.inputs.aws_region }}" || echo "Environment update failed - environment may not exist yet"

      - name: Cleanup
        if: always()
        working-directory: ./backend
        run: |
          APP_NAME="${{ github.event.inputs.backend_app_name || vars.BACKEND_APP_NAME }}"
          if [ -f "${APP_NAME}.zip" ]; then
            rm "${APP_NAME}.zip"
          fi

  deployment-summary:
    needs: [validate-inputs, deploy-frontend, deploy-backend]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          FRONTEND_S3_BUCKET="${{ github.event.inputs.frontend_s3_bucket || vars.FRONTEND_S3_BUCKET }}"
          CLOUDFRONT_ID="${{ github.event.inputs.cloudfront_distribution_id || vars.CLOUDFRONT_DISTRIBUTION_ID }}"
          BACKEND_APP_NAME="${{ github.event.inputs.backend_app_name || vars.BACKEND_APP_NAME }}"
          BACKEND_S3_BUCKET="${{ github.event.inputs.backend_s3_bucket || vars.BACKEND_S3_BUCKET }}"

          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: ${{ github.event.inputs.branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **AWS Region**: ${{ github.event.inputs.aws_region }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.validate-inputs.outputs.deploy-frontend }}" = "true" ]; then
            echo "### Frontend Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- **S3 Bucket**: $FRONTEND_S3_BUCKET" >> $GITHUB_STEP_SUMMARY
            echo "- **CloudFront Distribution**: $CLOUDFRONT_ID" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ${{ needs.deploy-frontend.result }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if [ "${{ needs.validate-inputs.outputs.deploy-backend }}" = "true" ]; then
            echo "### Backend Deployment" >> $GITHUB_STEP_SUMMARY
            echo "- **Application Name**: $BACKEND_APP_NAME" >> $GITHUB_STEP_SUMMARY
            echo "- **S3 Bucket**: $BACKEND_S3_BUCKET" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ${{ needs.deploy-backend.result }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Environment Variables Used" >> $GITHUB_STEP_SUMMARY
          echo "- **FRONTEND_S3_BUCKET**: ${{ vars.FRONTEND_S3_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "- **CLOUDFRONT_DISTRIBUTION_ID**: ${{ vars.CLOUDFRONT_DISTRIBUTION_ID }}" >> $GITHUB_STEP_SUMMARY
          echo "- **BACKEND_APP_NAME**: ${{ vars.BACKEND_APP_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "- **BACKEND_S3_BUCKET**: ${{ vars.BACKEND_S3_BUCKET }}" >> $GITHUB_STEP_SUMMARY

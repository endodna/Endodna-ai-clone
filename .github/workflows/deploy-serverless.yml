name: Deploy Serverless Functions

on:
  workflow_dispatch:
    inputs:
      function_folder:
        description: 'Select the function folder to deploy'
        required: true
        type: choice
        options:
          - copy-files
          - preprocess-files
      environment:
        description: 'Environment to deploy to'
        required: true
        type: choice
        options:
          - prod

env:
  AWS_REGION: us-east-1

jobs:
  deploy:
    name: Deploy ${{ github.event.inputs.function_folder }}
    runs-on: ubuntu-latest
    
    permissions:
      id-token: write
      contents: read
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: serverless/${{ github.event.inputs.function_folder }}/package.json

      - name: Get Lambda Function ARN
        id: get_arn
        env:
          COPY_FILES_ARN: ${{ vars.FUNCTION_ARN_COPY_FILES }}
          PREPROCESS_FILES_ARN: ${{ vars.FUNCTION_ARN_PREPROCESS_FILES }}
        run: |
          # Convert folder name to uppercase with underscores and extract ARN
          FOLDER_UPPER=$(echo ${{ github.event.inputs.function_folder }} | tr '[:lower:]' '[:upper:]' | tr '-' '_')
          
          case "$FOLDER_UPPER" in
            COPY_FILES)
              ARN="$COPY_FILES_ARN"
              ;;
            PREPROCESS_FILES)
              ARN="$PREPROCESS_FILES_ARN"
              ;;
            *)
              echo "Error: Unknown function folder: ${{ github.event.inputs.function_folder }}"
              exit 1
              ;;
          esac
          
          if [ -z "$ARN" ]; then
            echo "Error: ARN not found for function ${{ github.event.inputs.function_folder }}"
            exit 1
          fi
          
          echo "ARN=$ARN" >> $GITHUB_OUTPUT
          echo "Using ARN: $ARN"

      - name: Install dependencies
        run: |
          cd serverless/${{ github.event.inputs.function_folder }}
          npm ci

      - name: Build function
        run: |
          cd serverless/${{ github.event.inputs.function_folder }}
          npm run build

      - name: Create deployment package
        run: |
          cd serverless/${{ github.event.inputs.function_folder }}
          zip -r function.zip dist/ node_modules/ package.json

      - name: Extract function name from ARN
        id: extract_name
        run: |
          ARN="${{ steps.get_arn.outputs.ARN }}"
          FUNCTION_NAME=$(echo $ARN | awk -F: '{print $NF}')
          echo "FUNCTION_NAME=$FUNCTION_NAME" >> $GITHUB_OUTPUT
          echo "Function name: $FUNCTION_NAME"

      - name: Update Lambda function code
        run: |
          aws lambda update-function-code \
            --function-name ${{ steps.extract_name.outputs.FUNCTION_NAME }} \
            --zip-file fileb://serverless/${{ github.event.inputs.function_folder }}/function.zip \
            --region ${{ env.AWS_REGION }}

      - name: Wait for Lambda update to complete
        run: |
          aws lambda wait function-updated \
            --function-name ${{ steps.extract_name.outputs.FUNCTION_NAME }} \
            --region ${{ env.AWS_REGION }}

      - name: Publish Lambda function version (optional)
        run: |
          aws lambda publish-version \
            --function-name ${{ steps.extract_name.outputs.FUNCTION_NAME }} \
            --description "Deployed via GitHub Actions - ${{ github.sha }}" \
            --region ${{ env.AWS_REGION }} || true

      - name: Cleanup
        if: always()
        run: |
          cd serverless/${{ github.event.inputs.function_folder }}
          rm -f function.zip

      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Function**: \`${{ github.event.inputs.function_folder }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: \`${{ github.event.inputs.environment }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Lambda ARN**: \`${{ steps.get_arn.outputs.ARN }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: \`${{ github.actor }}\`" >> $GITHUB_STEP_SUMMARY

// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Admin {
  id                   String          @id @unique
  firstName            String
  lastName             String
  middleName           String?
  email                String?         @unique
  photo                String?
  status               Status          @default(PENDING)
  adminLogins          AdminLogin[]
  adminAuditLogs       AdminAuditLog[]
  organizationsCreated Organization[]
  sessions             AdminSession[]
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
}

model AdminLogin {
  id         Int      @id @default(autoincrement())
  adminId    String
  admin      Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  ip         String?
  appVersion String?
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model AdminAuditLog {
  id          Int      @id @default(autoincrement())
  adminId     String
  admin       Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  description String
  priority    Priority
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model AdminSession {
  id        Int       @id @default(autoincrement())
  adminId   String
  admin     Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  isValid   Boolean   @default(true)
  sessionId String    @unique
  logoutAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Organization {
  id                       Int                        @id @default(autoincrement())
  uuid                     String                     @default(uuid())
  name                     String
  isPrimary                Boolean                    @default(false)
  createdBy                String
  createdByAdmin           Admin?                     @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  customizations           OrganizationCustomization?
  createdAt                DateTime                   @default(now())
  updatedAt                DateTime                   @updatedAt
  organizationUser         OrganizationUser[]
  organizationUserInvites  OrganizationUserInvites[]
  patientActivities        PatientActivity[]
  patientAllergies         PatientAllergy[]
  patientActiveMedications PatientActiveMedication[]
  patientProblemLists      PatientProblemList[]
  patientGoals             PatientGoal[]
  patientTreatmentPlans    PatientTreatmentPlan[]
  patientMedicalRecords    PatientMedicalRecord[]
  patientLabResults        PatientLabResult[]
  patientDNAResults        PatientDNAResultKit[]
  patientChatConversations PatientChatConversation[]
  tokenUsage               TokenUsage[]
  patientChartNotes        PatientChartNote[]
  systemAuditLogs          SystemAuditLog[]
  patientAlerts            PatientAlert[]
  generalChatConversations GeneralChatConversation[]
  patientSummaries         PatientSummary[]
  reports                  Report[]
  patientReports           PatientReport[]
  patientOrders            PatientOrder[]
  patientAddresses         PatientAddress[]
  patientInfos             PatientInfo[]
  patientDosageHistories   PatientDosageHistory[]
}

model OrganizationCustomization {
  id             Int          @id @default(autoincrement())
  organizationId Int          @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  customization  Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model OrganizationUser {
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userType       UserType     @default(PATIENT)
  status         Status       @default(PENDING)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, userId])
}

model OrganizationUserInvites {
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedById    String
  invitedBy      User?        @relation(fields: [invitedById], references: [id], onDelete: Cascade)
  email          String
  token          String
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([organizationId, email])
}

model User {
  id                         String                     @id @unique
  firstName                  String
  lastName                   String
  email                      String?                    @unique
  middleName                 String?
  photo                      String?
  phoneNumber                String?
  workPhoneNumber            String?
  homePhoneNumber            String?
  dateOfBirth                DateTime?
  bloodType                  String?
  managingDoctorId           String?
  gender                     String?
  address                    Json?
  emergencyContact           Json?
  isPasswordSet              Boolean                    @default(false)
  status                     Status                     @default(PENDING)
  userType                   UserType?                  @default(PATIENT)
  logins                     UserLogin[]
  auditLogs                  UserAuditLog[]
  organizationUsers          OrganizationUser[]
  organizationUserInvites    OrganizationUserInvites[]
  sessions                   UserSession[]
  createdAt                  DateTime                   @default(now())
  updatedAt                  DateTime                   @updatedAt
  managingDoctor             User?                      @relation("ManagingDoctor", fields: [managingDoctorId], references: [id])
  patientsManaged            User[]                     @relation("ManagingDoctor")
  userDoctors                PatientDoctor[]            @relation("Patient")
  userPatients               PatientDoctor[]            @relation("Doctor")
  patientActivities          PatientActivity[]
  patientAllergies           PatientAllergy[]
  patientProblemLists        PatientProblemList[]
  patientGoals               PatientGoal[]
  patientTreatmentPlans      PatientTreatmentPlan[]
  patientMedicalRecords      PatientMedicalRecord[]     @relation("Patient")
  doctorMedicalRecords       PatientMedicalRecord[]     @relation("Doctor")
  patientLabResults          PatientLabResult[]
  patientDNAResults          PatientDNAResultKit[]
  patientActiveMedications   PatientActiveMedication[]  @relation("Patient")
  doctorGivenMedications     PatientActiveMedication[]  @relation("Doctor")
  patientChatConversations   PatientChatConversation[]  @relation("Patient")
  doctorChatConversations    PatientChatConversation[]  @relation("Doctor")
  patientChartNotes          PatientChartNote[]         @relation("Patient")
  doctorChartNotes           PatientChartNote[]         @relation("Doctor")
  systemAuditLogs            SystemAuditLog[]
  patientTokenUsages         TokenUsage[]               @relation("Patient")
  doctorTokenUsages          TokenUsage[]               @relation("Doctor")
  patientAlerts              PatientAlert[]
  generalChatConversations   GeneralChatConversation[]
  patientSummaries           PatientSummary[]           @relation("Patient")
  doctorSummaries            PatientSummary[]           @relation("Doctor")
  patientReports             PatientReport[]            @relation("Patient")
  doctorReports              PatientReport[]            @relation("Doctor")
  patientOrders              PatientOrder[]
  patientAddresses           PatientAddress[]
  patientDNAResultActivities PatientDNAResultActivity[]
  patientInfo                PatientInfo?
  patientDosageHistories     PatientDosageHistory[]     @relation("Patient")
  doctorDosageHistories      PatientDosageHistory[]     @relation("Doctor")
}

model PatientInfo {
  id              String       @id @unique @default(uuid())
  weight          Int?
  height          Int?
  age             Int?
  bloodType       String?
  bmi             Int?
  prefilledData   Json?
  clinicalData    Json?
  lifestyleData   Json?
  medicationsData Json?
  isOutdated      Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organizationId  Int
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId       String       @unique
  patient         User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
}

model PatientDosageHistory {
  id                       String                    @id @unique @default(uuid())
  data                     Json?
  type                     DosageHistoryType
  isOverridden             Boolean                   @default(false)
  doctorId                 String
  doctor                   User                      @relation("Doctor", fields: [doctorId], references: [id], onDelete: Cascade)
  createdAt                DateTime                  @default(now())
  updatedAt                DateTime                  @updatedAt
  organizationId           Int
  organization             Organization              @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId                String
  patient                  User                      @relation(name: "Patient", fields: [patientId], references: [id], onDelete: Cascade)
  patientActiveMedications PatientActiveMedication[]
  patientChartNotes        PatientChartNote[]
}

enum DosageTier {
  conservative
  standard
  aggressive
  high_performance
}

enum DosageHistoryType {
  T100
  T200
  ESTRADIOL
}

model PatientActivity {
  id             Int          @id @unique @default(autoincrement())
  uuid           String       @unique @default(uuid())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  activity       String
  dateRequested  DateTime?    @default(now())
  dateCompleted  DateTime?
  status         Status       @default(PENDING)
  metadata       Json?
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model PatientDoctor {
  id          Int       @id @unique @default(autoincrement())
  uuid        String    @unique @default(uuid())
  patientId   String
  doctorId    String
  patient     User      @relation(name: "Patient", fields: [patientId], references: [id], onDelete: Cascade)
  doctor      User      @relation(name: "Doctor", fields: [doctorId], references: [id], onDelete: Cascade)
  status      Status    @default(PENDING)
  dateRemoved DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model PatientAllergy {
  id             Int          @id @unique @default(autoincrement())
  uuid           String       @unique @default(uuid())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId      String
  patient        User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  allergen       String
  reactionType   String?
  severity       String?
  notes          String?
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model PatientAlert {
  id             Int          @id @unique @default(autoincrement())
  uuid           String       @unique @default(uuid())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId      String
  patient        User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  description    String
  severity       String?
  notes          String?
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model PatientActiveMedication {
  id                     Int                   @id @unique @default(autoincrement())
  uuid                   String                @unique @default(uuid())
  organizationId         Int
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId              String
  patient                User                  @relation(name: "Patient", fields: [patientId], references: [id], onDelete: Cascade)
  doctorId               String
  doctor                 User                  @relation(name: "Doctor", fields: [doctorId], references: [id], onDelete: Cascade)
  drugName               String
  dosage                 String
  frequency              String
  patientDosageHistoryId String?
  patientDosageHistory   PatientDosageHistory? @relation(fields: [patientDosageHistoryId], references: [id], onDelete: Cascade)
  startDate              DateTime?
  endDate                DateTime?
  reason                 String
  notes                  String?
  deletedAt              DateTime?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt
}

model PatientProblemList {
  id             Int          @id @unique @default(autoincrement())
  uuid           String       @unique @default(uuid())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId      String
  patient        User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  problem        String
  severity       String?
  status         Status       @default(PENDING)
  notes          String
  onsetDate      DateTime
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model PatientGoal {
  id             Int          @id @unique @default(autoincrement())
  uuid           String       @unique @default(uuid())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId      String
  patient        User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  description    String
  targetDate     DateTime?
  allergies      Int[]
  medications    Int[]
  problems       Int[]
  treatments     Int[]
  status         Status       @default(PENDING)
  notes          String
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model PatientTreatmentPlan {
  id               Int          @id @unique @default(autoincrement())
  uuid             String       @unique @default(uuid())
  organizationId   Int
  organization     Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId        String
  patient          User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  planName         String
  planContent      Json?
  startDate        DateTime
  endDate          DateTime
  sourceTemplateId String?
  status           Status       @default(PENDING)
  deletedAt        DateTime?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
}

model PatientMedicalRecord {
  id                     Int                         @id @unique @default(autoincrement())
  uuid                   String                      @unique @default(uuid())
  organizationId         Int
  organization           Organization                @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId              String
  patient                User                        @relation(name: "Patient", fields: [patientId], references: [id], onDelete: Cascade)
  content                Json?
  title                  String?
  type                   MedicalRecordType?          @default(CONSULTATION)
  sourceUrl              String
  fileMetadata           Json                        @default("{}")
  isProcessed            Boolean                     @default(false)
  isFailedProcessing     Boolean                     @default(false)
  failedProcessingReason String?
  doctorId               String
  doctor                 User                        @relation(name: "Doctor", fields: [doctorId], references: [id], onDelete: Cascade)
  chunks                 PatientMedicalRecordChunk[]
  deletedAt              DateTime?
  createdAt              DateTime                    @default(now())
  updatedAt              DateTime                    @updatedAt

  @@index([patientId, organizationId])
}

model PatientMedicalRecordChunk {
  id                     Int                          @id @unique @default(autoincrement())
  uuid                   String                       @unique @default(uuid())
  patientMedicalRecordId Int
  patientMedicalRecord   PatientMedicalRecord         @relation(fields: [patientMedicalRecordId], references: [id], onDelete: Cascade)
  chunkText              String
  chunkIndex             Int
  embedding              Unsupported("vector(1536)")?
  metadata               Json?
  createdAt              DateTime                     @default(now())
  updatedAt              DateTime                     @updatedAt

  @@index([patientMedicalRecordId])
}

model MasterSNP {
  id              Int    @id @unique @default(autoincrement())
  rsId            String
  geneName        String
  geneSummary     String
  chromosome      Int
  position_GRCh38 Int
  referenceAllele String
  altAllele       String

  createdAt                  DateTime                    @default(now())
  updatedAt                  DateTime                    @updatedAt
  patientDNAResultBreakdowns PatientDNAResultBreakdown[]
}

model PatientDNAResultKit {
  id                        Int                         @id @unique @default(autoincrement())
  uuid                      String                      @unique @default(uuid())
  organizationId            Int?
  organization              Organization?               @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId                 String?
  patient                   User?                       @relation(fields: [patientId], references: [id], onDelete: Cascade)
  barcode                   String
  reportId                  String?
  report                    Report?                     @relation(fields: [reportId], references: [id], onDelete: Cascade)
  fileMetadata              Json                        @default("{}")
  status                    DNAResultStatus             @default(PENDING)
  isFailedProcessing        Boolean                     @default(false)
  failedProcessingReason    String?
  isProcessed               Boolean                     @default(false)
  deletedAt                 DateTime?
  createdAt                 DateTime                    @default(now())
  updatedAt                 DateTime                    @updatedAt
  patientDNAResultActivity  PatientDNAResultActivity[]
  patientDNAResultBreakdown PatientDNAResultBreakdown[]
  patientOrders             PatientOrder[]
}

model PatientDNAResultBreakdown {
  id                 Int                 @id @unique @default(autoincrement())
  uuid               String              @unique @default(uuid())
  patientDNAResultId Int
  patientDNAResult   PatientDNAResultKit @relation(fields: [patientDNAResultId], references: [id], onDelete: Cascade)
  snpName            String
  chromosome         String
  position           Int
  referenceAllele    String
  alternateAllele    String
  genotype           String?
  masterSNPId        Int?
  masterSNP          MasterSNP?          @relation(fields: [masterSNPId], references: [id], onDelete: Cascade)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model PatientDNAResultActivity {
  id                 Int                 @id @unique @default(autoincrement())
  uuid               String              @unique @default(uuid())
  doctorId           String?
  doctor             User?               @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  patientDNAResultId Int
  patientDNAResult   PatientDNAResultKit @relation(fields: [patientDNAResultId], references: [id], onDelete: Cascade)
  activity           String
  status             DNAResultStatus     @default(KIT_RECEIVED)
  metadata           Json?
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model PatientLabResult {
  id             Int          @id @unique @default(autoincrement())
  uuid           String       @unique @default(uuid())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId      String
  patient        User         @relation(fields: [patientId], references: [id], onDelete: Cascade)
  bioMarkerName  String
  value          String
  unit           String?
  referenceRange String?
  status         Status?
  collectionDate DateTime?
  reportName     String?
  reportData     Json?
  sourceUrl      String?
  isProcessed    Boolean      @default(false)
  deletedAt      DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model UserLogin {
  id         Int      @id @default(autoincrement())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ip         String?
  appVersion String?
  metadata   Json?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

model UserAuditLog {
  id          Int      @id @default(autoincrement())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  description String
  priority    Priority
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model UserSession {
  id        Int       @id @default(autoincrement())
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  isValid   Boolean   @default(true)
  sessionId String    @unique
  logoutAt  DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

enum Status {
  ACTIVE
  INACTIVE
  PENDING
  DEACTIVATED
  BLOCKED
  DELETED
  ACHIEVED
  IN_PROGRESS
  CANCELLED
  RESOLVED
  IN_RANGE
  OUT_OF_RANGE
  LOW
  HIGH
  ANOMALOUS
  READY
}

enum DNAResultStatus {
  PENDING
  KIT_RECEIVED
  KIT_REGISTERED
  QC_FAILED
  QC_PASSED
  DNA_EXTRACTION_2ND_FAILED
  DNA_EXTRACTION_FAILED
  DNA_EXTRACTION_2ND_ACCEPTED
  DNA_EXTRACTION_ACCEPTED
  GENOTYPING_2ND_FAILED
  GENOTYPING_FAILED
  GENOTYPING_2ND_ACCEPTED
  GENOTYPING_ACCEPTED
  DATA_DELIVERED
  HOLD
  PROCESS
  CANCEL
  DISCARD
}

enum MedicalRecordType {
  CONSULTATION
  DIAGNOSIS
  TREATMENT
  FOLLOW_UP
  EMERGENCY
  LAB_RESULT
  IMAGING
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

enum UserType {
  PATIENT
  ADMIN
  SUPER_ADMIN
  DOCTOR
}

enum TaskType {
  MEDICAL_RECORD_PROCESSING
  PATIENT_SUMMARY_GENERATION
  DOCUMENT_EMBEDDING
  SIMILARITY_SEARCH
  TREATMENT_PLAN_GENERATION
  DIAGNOSIS_ASSISTANCE
  OTHER
}

enum RequestType {
  EMBEDDING
  TEXT_GENERATION
  TEXT_EMBEDDING
  CHAT_COMPLETION
}

enum ChatType {
  SUMMARY
  TREATMENT_PLAN
  GENERAL
  DNA_ANALYSIS
}

model PatientSummary {
  id              String       @id @default(uuid())
  patientId       String
  doctorId        String
  organizationId  Int
  summary         String
  followUpPrompts Json?
  context         Json?
  citations       Json?
  metadata        Json?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  patient         User         @relation("Patient", fields: [patientId], references: [id], onDelete: Cascade)
  doctor          User         @relation("Doctor", fields: [doctorId], references: [id], onDelete: Cascade)
  organization    Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId, organizationId])
}

enum ChatMessageRole {
  SYSTEM
  USER
  ASSISTANT
}

model PatientChatConversation {
  id             String   @id @default(uuid())
  patientId      String
  doctorId       String
  organizationId Int
  type           ChatType @default(GENERAL)
  title          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  patient      User                 @relation("Patient", fields: [patientId], references: [id], onDelete: Cascade)
  doctor       User                 @relation("Doctor", fields: [doctorId], references: [id], onDelete: Cascade)
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages     PatientChatMessage[]

  @@index([patientId, organizationId])
  @@index([doctorId, organizationId])
  @@index([patientId, doctorId, organizationId])
}

model PatientChatMessage {
  id             String          @id @default(uuid())
  conversationId String
  role           ChatMessageRole
  content        String
  version        Int             @default(1)
  inputTokens    Int?
  outputTokens   Int?
  latencyMs      Int?
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  conversation PatientChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([conversationId, version])
}

model GeneralChatConversation {
  id             String   @id @default(uuid())
  doctorId       String
  organizationId Int
  type           ChatType @default(GENERAL)
  title          String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  doctor       User                 @relation(fields: [doctorId], references: [id], onDelete: Cascade)
  organization Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages     GeneralChatMessage[]

  @@index([doctorId, organizationId])
}

model GeneralChatMessage {
  id             String          @id @default(uuid())
  conversationId String
  role           ChatMessageRole
  content        String
  version        Int             @default(1)
  inputTokens    Int?
  outputTokens   Int?
  latencyMs      Int?
  metadata       Json?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  conversation GeneralChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId, createdAt])
  @@index([conversationId, version])
}

model TokenUsage {
  id             Int          @id @unique @default(autoincrement())
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId      String?
  patient        User?        @relation(name: "Patient", fields: [patientId], references: [id], onDelete: SetNull)
  doctorId       String?
  doctor         User?        @relation(name: "Doctor", fields: [doctorId], references: [id], onDelete: SetNull)
  taskId         Int?
  taskType       TaskType
  requestType    RequestType
  modelId        String
  modelType      String
  inputTokens    Int
  outputTokens   Int
  totalTokens    Int
  inputCost      Decimal      @db.Decimal(10, 6)
  outputCost     Decimal      @db.Decimal(10, 6)
  totalCost      Decimal      @db.Decimal(10, 6)
  cacheHit       Boolean      @default(false)
  latencyMs      Int?
  metadata       Json?
  createdAt      DateTime     @default(now())
}

model PatientChartNote {
  id                     Int                   @id @unique @default(autoincrement())
  uuid                   String                @unique @default(uuid())
  organizationId         Int
  organization           Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientId              String
  patient                User                  @relation("Patient", fields: [patientId], references: [id], onDelete: Cascade)
  patientDosageHistoryId String?
  patientDosageHistory   PatientDosageHistory? @relation(fields: [patientDosageHistoryId], references: [id], onDelete: Cascade)
  doctorId               String?
  doctor                 User?                 @relation("Doctor", fields: [doctorId], references: [id], onDelete: SetNull)
  title                  String?
  content                String
  deletedAt              DateTime?
  createdAt              DateTime              @default(now())
  updatedAt              DateTime              @updatedAt

  @@index([patientId, organizationId])
  @@index([doctorId, organizationId])
  @@index([patientId, doctorId, organizationId])
  @@index([createdAt])
}

model SystemAuditLog {
  id             Int          @id @default(autoincrement())
  userId         String?
  user           User?        @relation(fields: [userId], references: [id], onDelete: Cascade)
  organizationId Int
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  action         String
  description    String
  priority       Priority
  metadata       Json?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
}

model PatientOrder {
  id             String               @id @default(uuid())
  organizationId Int
  organization   Organization         @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  orderId        String
  orderType      OrderType            @default(ACTIVATE_COLLECTION_KIT)
  patientId      String
  patient        User                 @relation(fields: [patientId], references: [id], onDelete: Cascade)
  status         Status               @default(PENDING)
  totalPrice     Decimal              @db.Decimal(10, 2)
  paymentStatus  PaymentStatus        @default(PENDING)
  dnaKitResultId Int?
  dnaKitResult   PatientDNAResultKit? @relation(fields: [dnaKitResultId], references: [id], onDelete: Cascade)
  addressId      String?
  address        PatientAddress?      @relation(fields: [addressId], references: [id], onDelete: Cascade)
  metadata       Json?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt
  deletedAt      DateTime?
  patientReports PatientReport[]
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

model Report {
  id                   String                @id @default(uuid())
  organizationId       Int
  icon                 String?
  code                 String
  title                String
  description          String?
  genders              Gender[]
  price                Decimal               @db.Decimal(10, 2)
  metadata             Json?
  currentVersionId     String?
  deletedAt            DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  organization         Organization          @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientDNAResultKits PatientDNAResultKit[]
  patientReports       PatientReport[]
  reportVersions       ReportVersion[]
  reportCategories     ReportCategory[]
}

model ReportCategory {
  id                 String              @id @default(uuid())
  name               String
  reportId           String
  report             Report              @relation(fields: [reportId], references: [id], onDelete: Cascade)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  deletedAt          DateTime?
  reportVersion      ReportVersion?      @relation(fields: [reportVersionId], references: [id])
  reportVersionId    String?
  reportCategorySNPs ReportCategorySNP[]
}

model ReportVersion {
  id               String           @id @default(uuid())
  reportId         String
  report           Report           @relation(fields: [reportId], references: [id], onDelete: Cascade)
  version          Int
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?
  reportCategories ReportCategory[]
  patientReports   PatientReport[]
}

model ReportCategorySNP {
  id               String         @id @default(uuid())
  reportCategoryId String
  reportCategory   ReportCategory @relation(fields: [reportCategoryId], references: [id], onDelete: Cascade)
  rsID             String
  pathogenicity    String
  genotype         String
  sources          String[]
  description      String
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  deletedAt        DateTime?
}

model PatientReport {
  id              String         @id @default(uuid())
  patientId       String
  doctorId        String?
  organizationId  Int
  reportId        String
  reportVersionId String?
  reportVersion   ReportVersion? @relation(fields: [reportVersionId], references: [id], onDelete: Cascade)
  orderId         String
  price           Decimal        @db.Decimal(10, 2)
  isPrimary       Boolean        @default(false)
  createdAt       DateTime       @default(now())
  status          Status         @default(PENDING)
  updatedAt       DateTime       @updatedAt
  deletedAt       DateTime?
  report          Report         @relation(fields: [reportId], references: [id], onDelete: Cascade)
  order           PatientOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  patient         User           @relation("Patient", fields: [patientId], references: [id], onDelete: Cascade)
  doctor          User?          @relation("Doctor", fields: [doctorId], references: [id], onDelete: Cascade)
  organization    Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([patientId, organizationId])
}

model PatientAddress {
  id             String         @id @default(uuid())
  patientId      String
  isPrimary      Boolean        @default(false)
  organizationId Int
  address        Json?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  deletedAt      DateTime?
  patient        User           @relation(fields: [patientId], references: [id], onDelete: Cascade)
  organization   Organization   @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  patientOrders  PatientOrder[]

  @@index([patientId, organizationId])
}

enum OrderType {
  ACTIVATE_COLLECTION_KIT
  SHIP_DIRECTLY_TO_PATIENT
  PATIENT_SELF_PURCHASE
}

enum Gender {
  ALL
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}
